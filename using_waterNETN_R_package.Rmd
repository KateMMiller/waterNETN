---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(width = 10)
```

```{css echo = FALSE}
.indent {
margin-left: 25px;
font-size: 14px;
}

.indent2 {
margin-left: 50px;
font-size: 12px;
}

.drop{
  font-family: "Arial",Arial,sans-serif;
  font-size: 16px;
  font-weight: bold;
  padding:0px 0px 0px 0px;
  margin:0px 0px 0px 0px;
}

.fxn{
  color:#1942B5;
  font-size:14px;
  font-weight: bold;
}

/*
h4{
  color:#1942B5;
}
*/
```

```{r echo = F, include = F}
print_head <- function(df){
  knitr::kable(df[1:6,]) |> #, table.attr = "style='width:60%;'") |> 
    kableExtra::kable_classic(full_width = F, font_size = 12, 
                              bootstrap_options = c("condensed"))
}
library(tidyverse)
park = 'all';site = 'all'; site_type = 'all'; years = 2006:2023; months = 1:12; output = 'short'
```

## Using the waterNETN R package {.tabset .tabset-pills}

### Getting started {.tabset}

#### Installation
<h4><b>Step 1.</b> Install R, RStudio, and RTools in Software Center</h4>
<h4><b>Step 2.</b> Install devtools package in R:</h4>
```{r, eval = F, class.source = "indent"}
install.packages('devtools')
```
<h4><b>Step 3.</b> Install waterNETN from github</h4>
Note that whenever the `waterNETN` package is updated, you can rerun this code to install the latest version.
```{r, eval = F, class.source = "indent"}
library(devtools)
install_github("KateMMiller/waterNETN")
```
<h4><b>Step 4.</b> Load waterNETN R package</h4>
```{r, class.source = "indent"}
library(waterNETN)
```
<h4><b>Step 5.</b> Import data</h4>
Note that R is not able to connect to files on Sharepoint or MS Teams (b/c Teams also stores all files on Sharepoint). That means you need to store data package files on your local machine or on a server (e.g. NETN Z drive). The default option for importing data will add the data package views (i.e., flatfiles) to an environment called VIEWS_WQ to your Environment work space (i.e. Environtment tab in top right panel). If you would rather import each individual view into your R session, specify with the new_env argument (e.g., `importData(new_env = F)`).
```{r echo = F, results = 'hide', include = F}
importData()
```
<p class = 'indent'>
<span style='color:#1942B5;'><b>Option 1.</b> Import data via .csv files. The file path should be where csvs are on your machine or server.</span></p>
```{r, eval = F, class.source = "indent"}
importData(type = 'csv',
           filepath = "C:/NETN/R_Dev/Water/data") # update filepath to your computer
```
<p class = 'indent'>
<span style='color:#1942B5;'><b>Option 2.</b> Import data via zip file of csvs. The filepath should be the location and name of the zip file.</span></p>
```{r eval = F, class.source = "indent"}
importData(type = 'zip',
           filepath = "C:/NETN/R_Dev/Water/data/NETN_Water_Data_Package_20240423.zip")
```
<p class = 'indent'>
<span style='color:#1942B5;'><b>Option 3.</b> Import data via data package database file on your computer</span></p>
```{r eval = F, class.source = "indent"}
importData(type = 'dbfile',
           filepath = "C:/NETN/R_Dev/Water/data/NETN_h3Ov4_DataPackage_202331115.accdb")
```
<p class = 'indent'>
<span style='color:#1942B5;'><b>Option 4.</b> Import data via data package database DSN (Data Source Name) on your computer. </span>
Note that this is the default setting. As long as you have a named DSN called "NETNWQ_DP" that links to the data package database, and that database links to the latest NETN WQ backend database, the code below will run. See <i>Setting up DSN</i> tab for how to set up DSN.</p>
```{r eval = F, class.source = "indent"}
importData() # easiest
importData(type = 'DSN', odbc = "NETNWQ_DP") # equivalent to line above
```
<h4><b>Step 6.</b> (Optional) Export data package to zip </h4>
You can export all of the csvs to a zip file with the day's date stamped on the file name. This allows you to import the tables from the database, then export the csvs as one zip file.
```{r eval = F, class.source = "indent"}
importData() # easiest
exportData(filepath = "./data", zip = TRUE) 
```

```{r eval = F, echo = F, class.source = "indent"}
importData() # easiest
exportData(filepath = "../data", zip = TRUE) 
```

<h4><b>Step 7. Play with the data</b></h4>
The functions in the `waterNETN` package are designed to work with the views, and are the best way to interact with the data to query by park, site, site type, year, parameter, etc. However, if you want to view the raw data, and you imported the data into the VIEWS_WQ environment, you can access them with the code below:
```{r eval = F}
# See list of the views
names(VIEWS_WQ)

# View one of the views
View(VIEWS_WQ$Chemistry_Data)

# Assign a view to a data frame named chem in R. Interact with chem the way you would work with any normal data frame in R. 
chem <- VIEWS_WQ$Chemistry_Data

```

#### Getting help
<h4><b>Getting (and improving) help</b></h4>
The functions in `waterNETN` have help documentation like any R package. To view the help, you can go to the Packages tab and click on waterNETN (see below). That will show you all the functions in the package. Clicking on individual functions will take you to the help documentation for that function. 
```{r echo = F, out.height = 150, fig.align = 'center'}
knitr::include_graphics("C:/NETN/R_Dev/Water/waterNETN/testing_scripts/finding_R_package.jpg")
```

<p class = 'fxn'>You can also see the help of a function by running, for example: </p>
```{r, class.source = 'indent', eval = F}
?importData
```

<p class = 'fxn'>If `waterNETN` isn't loaded yet, you'd run: </p>
```{r, class.source = 'indent', eval = F}
?waterNETN::importData
```

Each function's help includes a Description, Usage (i.e. function arguments and their defaults), Argument options/definitions, and several examples showing how the function can be used. 

<b><span style='color:red;'>This is where you come in! If you notice typos or can think of better descriptions, examples, error messages, etc., please send them my way!</b></span> After we're more comfortable with R packages and get versed on GitHub, you'll be able to make those changes directly in the package. For now, you can just send me your suggestions and I'll make the changes.

Finally, if you ever want to peak under the hood at the function, you can view it several ways. 
<ol>
<li>Keep F2 key pressed and click on the function name in R. This trick works for many but not all functions in R.</li>
<li>View code in the <a href="https://github.com/KateMMiller/waterNETN/tree/main">GitHub katemmiller/waterNETN repo</a>. The functions are in the R folder. 

#### Setting up DSN
<h4><b>Setting up a DSN</b></h4>
<ol>
<li>Go to Windows Start Menu and search ODBC. Click on ODBC Data Sources (64-bit) </li>

```{r echo = F, out.height = 350, fig.align = 'center'}
knitr::include_graphics("C:/NETN/R_Dev/Water/waterNETN/testing_scripts/ODBC_step_1.jpg")
```
<li>Click on <i>Add</i>, then select <i>Microsoft Access Driver (\*.mdb, \*.accdb)</i> then click <i>Finish</i> in next menu.</li>

```{r echo = F, out.height = 400, fig.align = 'center'}
knitr::include_graphics("C:/NETN/R_Dev/Water/waterNETN/testing_scripts/ODBC_step_2.jpg")
```

<li>Enter <b>NETNWQ_DP</b> into the Data Source Name (red arrow), click on Select (red circle). In new window, click on C:/ (orange arrow) and find the path to your database. If it's on the Z drive, then click on the Drives window and select correct Drive. Click on the data package database (yellow arrow). When complete, click OK. Finally, add the name of the database file to the Description (blue arrow), so it's easier to check whether you're using the latest version.  </li>
```{r echo = F, out.height = 400, fig.align = 'center'}
knitr::include_graphics("C:/NETN/R_Dev/Water/waterNETN/testing_scripts/ODBC_step_3.jpg")
```

<li>If updating an existing DSN, follow similar process, except click on the DSN in the first window and select <i>Configure</i> instead of Add.</li>
</ol>

### Climate Functions {.tabset}
#### Daymet
Daymet data are 1km gridded daily climate data, similar to PRISM data, but with more daily data associated with each location and more efficient downloading process (extract data from lat/long points, rather than download nationwide raster files and extract manually). Daymet data go back to 1980. See <a href="https://daymet.ornl.gov/">https://daymet.ornl.gov/</a> for more information. Another benefit of Daymet over PRISM is the data can be used to calculate drought indices, like Standardized Precipitation-Evapotranspiration Index (SPEI). Note: I'll eventually add SPEI metrics to the output of this function. 

Daymet data are typically available for a calendar year a a few months into the next year.

In waterNETN, you can download Daymet data by park, site, site type, and spanning years 1980 to 2023. See examples below. The larger the number of sites and years, the longer it can take. I added the option to save the data as a csv to disk via `export = T` and specifying a `filepath`, so you don't have to download these data over and over. I'll make it possible to read csvs into R to work with climate summary and plotting functions.  

<p class = 'fxn'>The following code downloads Daymet data for East Primrose Brook in MORR for the entire monitoring period, and exports to a data folder in the working directory.</p>
```{r}
prim <- getClimDaymet(site = "MORRSA", years = 2006:2023, export = T, filepath = "./data")
print_head(prim) # table of first 6 rows- this is a custom function I wrote to save on coding
```

```{r echo = F, include = F}
file.remove("./data/Daymet_climate_data_2006-2023.csv")
```

<p class = 'fxn'>The following code downloads Daymet data for all sites in MABI for 2023. Results are assigned to R session environment and not exported to data folder in the working directory.</p>
```{r}
# Daymet data for the Pogue and Pogue stream for 2023, but not exporting to disk.
mabi_dm <- getClimDaymet(park = "MABI", years = 2023)
print_head(mabi_dm)
```

#### Weather Station
For each NETN monitoring site, I used the `rnoaa` package to find all weather stations within 20km radius of each site's lat/long coordinates. I then checked the period of record for each of these sites. I selected the closest weather station with the longest period of record that included 2023 and 2024. This assessment was done at the park level, so the data for each site within a park is the same. The API used to download weather station data is <a href="data.rcc-acis.org">data.rcc-acis.org</a>. Unfortunately only temperature data are available for ACAD's McFarland Hill weather station (AKA MARS). ACAD's hourly precipitation data were downloaded separately from the NADP website <a href="http://nadp2.slh.wisc.edu/siteOps/ppt/">http://nadp2.slh.wisc.edu/siteOps/ppt/</a>. These data only go back to 2008 and were aggregated to daily total precipitation. This function is slower for ACAD as a result. Though note that data are downloaded at the park level, then joined with site-specific data. In other words, data are downloaded for a park x combination of years once, then joined to site-level data. Weather stations used and their distance from each site are included in the output.

<p class = 'fxn'>The following code downloads weather station data for all sites in ROVA during the monitoring period and writes to a csv.</p>
```{r}
rova_ws <- getClimWStat(park = "ROVA", years = 2006:2023, export = T, filepath = "./data")
print_head(rova_ws)
```

```{r echo = F, include = F}
file.remove("./data/Weather_station_data_2006-2023.csv")
```
<p class = 'fxn'>The following code downloads weather station data for all lakes in ACAD in 2023, but doesn't export to disk.</p>
```{r}
acad_ws <- getClimWStat(park = "ACAD", site_type = "lake", years = 2023)
print_head(acad_ws)
```

### get Data Functions {.tabset}
#### getSites()
Query site-level data. This function combines columns in common between the Sites_Stream and Sites_Lake views. This is a good building block for other functions, but may be less helpful on its own. Though, one helpful use of this function is to get the site codes for a given park or site.

<p class = 'fxn'>Get site info for ACAD lakes</p>
```{r}
ACAD_lakes <- getSites(park = "ACAD", site_type = "lake")
```

<p class = 'fxn'>Get site info for the Pogue</p>
```{r}
pogue <- getSites(site = "MABIPA")
```

<p class = 'fxn'>List site codes and their full site name for SARA</p>
```{r}
sara_sites <- getSites(park = "SARA") |> select(SiteCode, SiteName)
print_head(sara_sites)
```

#### getSitesLake()
Query site-level data for lakes only. This returns lake-only columns in the Sites_Lake views
<p class = 'fxn'>Get site info for ACAD lakes</p>
```{r}
ACAD_str <- getSitesLake(park = "ACAD")
print_head(ACAD_str)
```

<p class = 'fxn'>Get all site info for the Pogue Pond</p>
```{r}
pogue <- getSitesLake(site = "MABIPA", output = 'verbose')
print_head(pogue)
```

#### getSitesStream()
Query site-level data for streams only. This returns stream-only columns in the Sites_Stream views
<p class = 'fxn'>Get site info for ACAD streams</p>
```{r}
ACAD_str <- getSitesStream(park = "ACAD")
print_head(ACAD_str)
```

<p class = 'fxn'>Get all site info for the Pogue Stream</p>
```{r}
poguestr <- getSitesStream(site = "MABISA", output = 'verbose')
print_head(poguestr)
```

#### getEvents()
Query water data by park, site, site_type, year and month. 

<p class = 'fxn'>Get event info for Witch Hole Pond in ACAD in 2023</p>
```{r}
ACAD_lakes <- getEvents(site = "ACWHOL", years = 2023)
print_head(ACAD_lakes)
```

<p class = 'fxn'>Get event info for all years in the Pogue</p>
```{r}
pogue <- getEvents(site = "MABIPA", years = 2006:2023)
print_head(pogue)
```

<p class = 'fxn'>Get date of sampling each site in lower NETN in May, 2023</p>
```{r}
lnetn <- c("MABI", "MIMA", "MORR", "ROVA", "SAGA", "SAIR", "SARA", "WEFA")
lnetn_evs <- getEvents(park = lnetn, years = 2023, months = 5) |> 
  select(SiteCode, SiteName, EventDate)
print_head(lnetn_evs) #just printing first 6 rows
```

#### getChemistry()
This function allows you to query the Chemistry_Data view by park, site, site type, year, month,  parameter, sample type, and sample depth type (i.e., surface vs. below surface). The returned data frame is long (i.e. stacked) to facilitate data summary and plotting (coming soon).

<p class = 'fxn'>Get N parameters for all sites and non-QAQC events in MIMA.</p> 
Note that `QC_type = "ENV"` is the default for this function, which returns only non-QAQC events. Note also the use of named objects for the arguments. This allows you to set them at the top of a script, rather than having to type them out repeatedly. You can then change them in 1 place (i.e., update the year to 2024) and rerun the code. 
```{r}
n_params <- c("NH3", "NH3_mgL", "NO2", "NO2_mgL", "NO2+NO3", 
              "NO2+NO3_mgL", "NO3", "NO3_ueqL", "TN", "TN_mgL")
period <- 2006:2023
mima_n <- getChemistry(park = "MIMA", years = period, parameter = n_params)
print_head(mima_n) # top 6 rows
```

<p class = 'fxn'>Get ChlA for all events, including QC samples, in 2023 for Jordan Pond in ACAD</p>
```{r}
jord <- getChemistry(site = "ACJORD", QC_type = "all", param = "ChlA", years = 2023)
print_head(jord)
```

<p class = 'fxn'>Get ANC for LNETN parks for all years during month of May. Note that by not specifying years, all years by default will be included in the output.</p>
```{r}
lnetn <- c("MABI", "MIMA", "MORR", "ROVA", "SAGA", "SAIR", "SARA", "WEFA")
anc <- getChemistry(park = lnetn, param = "ANC", months = 5)
print_head(anc)
```

<p class = 'fxn'>Get surface-only measurements, defined as as the medium of all samples within 2m of the surface for ACAD lakes from 2021:2023. If more than one measurement exists, the value represents the median of all samples within 2m of the surface.</p>
```{r}
surf <- getChemistry(park = "ACAD", site_type = "lake", years = 2021:2023, sample_depth = 'surface')
print_head(surf)
```

<p class = 'fxn'>Get censored and non-censored NH3 data for LNETN all years. Note the Flag column indicates the measurement is censored by reporting the detection limit used.</p>
```{r}
lnetn <- c("MABI", "MIMA", "MORR", "ROVA", "SAGA", "SAIR", "SARA", "WEFA")
cens <- getChemistry(park = lnetn, param = "NH3", include_censored = TRUE)
print_head(cens) 
```

#### getDischarge()
This function allows you to query the Discharge_Data view by park, site, site type, year, month, measurement method (e.g., flowtracker or pygmy), and measurement rating (e.g., E, G, F, P). Note that you can also return all columns or a reduced set of columns with the output argument. Default is output = 'short'. This function is set up to work with site_type = 'stream', so you don't have to specify that.

<p class = 'fxn'>Get discharge data for all LNETN sites and years measured with flowtracker </p>
```{r}
lnetn <- c("MABI", "MIMA", "MORR", "ROVA", "SAGA", "SAIR", "SARA", "WEFA")
ft <- getDischarge(park = lnetn, method = "LNETN Pygmy")
print_head(ft)
```

<p class = 'fxn'>Get discharge data for all ACAD streams with measurement rating of Excellent or Good </p>
```{r}
acad <- getDischarge(park = "ACAD", rating = c("E", "G"))
str(acad) # structure of returned data
```

#### getLightPen()
This function allows you to query the Light_Penetration_Data view by park, site, site type, year, and month. Again output = 'short' is the default. If specify output = 'verbose', you'll get all possible columns. This is only set up to work with site_type = 'lake', so you don't have to specify that.

<p class = 'fxn'>Get light penetration for Weir Pond from 2013 - 2023 all months.</p> 
```{r}
period <- 2013:2023
wefa <- getLightPen(park = "WEFA", years = period)
print_head(wefa) # top 6 rows
```

<p class = 'fxn'>Get light penetration for ACAD lakes in 2023 in July and August.</p> 
```{r}
acad <- getLightPen(park = "ACAD", years = 2023, months = 7:8)
print_head(acad) # top 6 rows
```

#### getSecchi()
This function allows you to query Secchi data by park, site, site type, years, months and whether you want to return all observations, the first or the second. Default returns all observations with data. Note that this function is designed to only work with lakes, and doesn't require site_type = "lake" to be specified.
<p class = 'fxn'>Get Secchi depth the Pogue from 2021-2023, first observer only</p>
```{r}
mabi <- getSecchi(site = "MABIPA", years = 2021:2023, observer_type = "first")
print_head(mabi)
```

<p class = 'fxn'>Get Secchi for all ACAD lakes sampled in July for all observers
```{r}
ACAD_lake <- getSecchi(park = 'ACAD', months = 7)
print_head(ACAD_lake)
```

#### getSondeInSitu()
This function allows you to query Sonde in situ data by park, site, site type, years, months, parameter, QC type, surface vs. all, etc. Default returns all non-QAQC observations with data. The Sonde_InSitu_Data view is large and can take a few seconds to run for most parks, sites, years, parameters, etc.

<p class = 'fxn'>Get Sonde data for all sites and parameters in MABI from 2021-2023 for non-QAQC samples</p>
```{r}
mabi <- getSondeInSitu(park = "MABI", years = 2021:2023)
print_head(mabi)
```

<p class = 'fxn'>get data for all DO parameters in MIMA from 2006-2023 for non-QAQC samples</p>
```{r}
params <- c("DOsat_pct", "DOsatLoc_pct", "DO_mgL")
period <- 2006:2023
mima_do <- getSondeInSitu(park = "MIMA", years = period, parameter = params)
print_head(mima_do)
```

<p class = 'fxn'>Get Temp data for surface measurements, defined as the medium of all samples within 2m of the surface, only in Jordan Pond in ACAD for non-QAQC samples</p>
```{r}
ACAD_lake <- getSondeInSitu(site = 'ACJORD', parameter = "Temp_C", sample_depth = "surface")
```

<p class = 'fxn'>Get pH for lower NETN parks from May to Oct for QAQC and non-QAQC samples</p>
```{r}
lnetn <- c("MABI", "MIMA", "MORR", "ROVA", "SAGA", "SAIR", "SARA", "WEFA")
lnetn_ph <- getSondeInSitu(park = lnetn, param = "pH", months = 5:10, QC_type = 'all')
```

#### getStreamObs()
This function allows you to query stream observation data by park, site, year and month
<p class = 'fxn'>Get stream observations for Pogue Stream all years</p>
```{r}
mabi <- getStreamObs(park = "MABI")
print_head(mabi)
```
<p class = 'fxn'>Get observations for all streams in ACAD May 2023 </p>
```{r}
ACAD_streams <- getStreamObs(park = 'ACAD', years = 2023, months = 5)
print_head(ACAD_streams)
```

#### getWaterLevel()
This function joins stage and water level data, and allows you to query by park, site, site_type, year, and month. Note that WL data start in 2013 in the view. 

<p class = 'fxn'>Get water level data for Bubble Pond. </p>
```{r}
bubl <- getWaterLevel(site = "ACBUBL", years = 2013:2023)
print_head(bubl)
```

<p class = 'fxn'>Get water level data for Weir Pond in August. </p>
```{r}
weir <- getWaterLevel(site = "WEFAPA", months = 8)
print_head(weir)
```


### Summary Functions {.tabset}
WIP

### Plotting Functions {.tabset}
WIP


