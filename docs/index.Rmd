---
output: html_document
title: "Using waterNETN R pkg." 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(width = 10)
```

```{css echo = FALSE}
.indent {
margin-left: 25px;
font-size: 14px;
}

.indent2 {
margin-left: 50px;
font-size: 12px;
}

.drop{
  font-family: "Arial",Arial,sans-serif;
  font-size: 16px;
  font-weight: bold;
  padding:0px 0px 0px 0px;
  margin:0px 0px 0px 0px;
}

.fxn{
  color:#1942B5;
  font-size:14px;
  font-weight: bold;
}

.title{
 display:none;
}
/*
h4{
  color:#1942B5;
}
*/
```

```{r echo = F, include = F}
print_head <- function(df){
  knitr::kable(df[1:6,]) |> #, table.attr = "style='width:60%;'") |> 
    kableExtra::kable_classic(full_width = F, font_size = 12, 
                              bootstrap_options = c("condensed"))
}
library(tidyverse)
park = 'all';site = 'all'; site_type = 'all'; years = 2006:2023; months = 1:12; output = 'short'
parameter = c("ANC", "NH3", "pH", "Temp_C", "SDepth_m", "Discharge_csf", "PenetrationRatio");
... = NULL; smooth = F; layers = c("points", "lines"); threshold = T; legend_position = 'bottom'; span = 0.6
```

## Using the waterNETN R package {.tabset .tabset-pills}

### Getting started {.tabset}

#### Installation
<h4><b>Step 1.</b> Install R, RStudio, and RTools in Software Center</h4>
<h4><b>Step 2.</b> Install devtools package in R:</h4>
```{r, eval = F, class.source = "indent"}
install.packages('devtools')
```
<h4><b>Step 3.</b> Install waterNETN and climateNETN from github</h4>
Note that whenever the `waterNETN` package is updated, you can rerun this code to install the latest version.
```{r, eval = F, class.source = "indent"}
library(devtools)
install_github("KateMMiller/waterNETN")
install_github("KateMMiller/climateNETN")
```
<h4><b>Step 4.</b> Load waterNETN R package</h4>
```{r, class.source = "indent"}
library(waterNETN)
library(climateNETN)
```
<h4><b>Step 5.</b> Import data</h4>
Note that R is not able to connect to files on Sharepoint or MS Teams (b/c Teams also stores all files on Sharepoint). That means you need to store data package files on your local machine or on a server (e.g. NETN Z drive). The default option for importing data will add the data package views (i.e., flatfiles) to an environment called VIEWS_WQ to your Environment work space (i.e. Environment tab in top right panel). If you would rather import each individual view into your R session, specify with the new_env argument (e.g., `importData(new_env = F)`).
```{r echo = F, results = 'hide', include = F}
importData()
```
<p class = 'indent'>
<span style='color:#1942B5;'><b>Option 1.</b> Import data via .csv files. The file path should be where csvs are on your machine or server.</span></p>
```{r, eval = F, class.source = "indent"}
importData(type = 'csv',
           filepath = "C:/NETN/R_Dev/Water/data") # update filepath to your computer
```
<p class = 'indent'>
<span style='color:#1942B5;'><b>Option 2.</b> Import data via zip file of csvs. The filepath should be the location and name of the zip file.</span></p>
```{r eval = F, class.source = "indent"}
importData(type = 'zip',
           filepath = "C:/NETN/R_Dev/Water/data/NETN_Water_Data_Package_20240423.zip")
```
<p class = 'indent'>
<span style='color:#1942B5;'><b>Option 3.</b> Import data via data package database file on your computer</span></p>
```{r eval = F, class.source = "indent"}
importData(type = 'dbfile',
           filepath = "C:/NETN/R_Dev/Water/data/NETN_h3Ov4_DataPackage_202331115.accdb")
```
<p class = 'indent'>
<span style='color:#1942B5;'><b>Option 4.</b> Import data via data package database DSN (Data Source Name) on your computer. </span>
Note that this is the default setting. As long as you have a named DSN called "NETNWQ_DP" that links to the data package database, and that database links to the latest NETN WQ backend database, the code below will run. See <i>Setting up DSN</i> tab for how to set up DSN.</p>
```{r eval = F, class.source = "indent"}
importData() # easiest
importData(type = 'DSN', odbc = "NETNWQ_DP") # equivalent to line above
```
<h4><b>Step 6.</b> (Optional) Export data package to zip </h4>
You can export all of the csvs to a zip file with the day's date stamped on the file name. This allows you to import the tables from the database, then export the csvs as one zip file.
```{r eval = F, class.source = "indent"}
importData() # easiest
exportData(filepath = "./data", zip = TRUE) 
```

```{r eval = F, echo = F, class.source = "indent"}
importData() # easiest
exportData(filepath = "../data", zip = TRUE) 
```

<h4><b>Step 7. Play with the data</b></h4>
The functions in the `waterNETN` package are designed to work with the views, and are the best way to interact with the data to query by park, site, site type, year, parameter, etc. However, if you want to view the raw data, and you imported the data into the VIEWS_WQ environment, you can access them with the code below:
```{r eval = F}
# See list of the views
names(VIEWS_WQ)

# View one of the views
View(VIEWS_WQ$Chemistry_Data)

# Assign a view to a data frame named chem in R. Interact with chem the way you would work with any normal data frame in R. 
chem <- VIEWS_WQ$Chemistry_Data

```

If you want to use the `print_head()` function that shows output in the markdown, run the code below. This makes the results print cleaner in the markdown report. For your purposes, you can just run: `head(dataframe)`.
```{r}
print_head <- function(df){
  knitr::kable(df[1:6,]) |> #, table.attr = "style='width:60%;'") |> 
    kableExtra::kable_classic(full_width = F, font_size = 12, 
                              bootstrap_options = c("condensed"))
}

```
#### Getting help
<h4><b>Getting (and improving) help</b></h4>
The functions in `waterNETN` have help documentation like any R package. To view the help, you can go to the Packages tab and click on waterNETN (see below). That will show you all the functions in the package. Clicking on individual functions will take you to the help documentation for that function. 
```{r echo = F, out.width = 500, fig.align = 'center'}
knitr::include_graphics("C:/NETN/R_Dev/Water/waterNETN/testing_scripts/finding_R_package.jpg")
```

<p class = 'fxn'>You can also see the help of a function by running, for example: </p>
```{r, class.source = 'indent', eval = F}
?importData
```

<p class = 'fxn'>If `waterNETN` isn't loaded yet, you'd run: </p>
```{r, class.source = 'indent', eval = F}
?waterNETN::importData
```

Each function's help includes a Description, Usage (i.e. function arguments and their defaults), Argument options/definitions, and several examples showing how the function can be used. 

<b><span style='color:red;'>This is where you come in! If you notice typos or can think of better descriptions, examples, error messages, etc., please send them my way!</b></span> After we're more comfortable with R packages and get versed on GitHub, you'll be able to make those changes directly in the package. For now, you can just send me your suggestions and I'll make the changes.

Finally, if you ever want to peak under the hood at the function, you can view it several ways. 
<ol>
<li>Keep F2 key pressed and click on the function name in R. This trick works for many but not all functions in R.</li>
<li>View code in the <a href="https://github.com/KateMMiller/waterNETN/tree/main">GitHub katemmiller/waterNETN repo</a>. The functions are in the R folder. 

#### Setting up DSN
<h4><b>Setting up a DSN</b></h4>
<ol>
<li>Go to Windows Start Menu and search ODBC. Click on ODBC Data Sources (64-bit) </li>

```{r echo = F, out.height = '457px', out.width = '564px', fig.align = 'center'}
knitr::include_graphics("C:/NETN/R_Dev/Water/waterNETN/testing_scripts/ODBC_step_1.jpg")
```
<li>Click on <i>Add</i>, then select <i>Microsoft Access Driver (\*.mdb, \*.accdb)</i> then click <i>Finish</i> in next menu.</li>

```{r echo = F, out.height = '450px', out.width = '1018px', fig.align = 'center'}
knitr::include_graphics("C:/NETN/R_Dev/Water/waterNETN/testing_scripts/ODBC_step_2.jpg")
```

<li>Enter <b>NETNWQ_DP</b> into the Data Source Name (red arrow), click on Select (red circle). In new window, click on C:/ (orange arrow) and find the path to your database. If it's on the Z drive, then click on the Drives window and select correct Drive. Click on the data package database (yellow arrow). When complete, click OK. Finally, add the name of the database file to the Description (blue arrow), so it's easier to check whether you're using the latest version.  </li>
```{r echo = F, out.height = '486px', out.width = '600px', fig.align = 'center'}
knitr::include_graphics("C:/NETN/R_Dev/Water/waterNETN/testing_scripts/ODBC_step_3.jpg")
```

<li>If updating an existing DSN, follow similar process, except click on the DSN in the first window and select <i>Configure</i> instead of Add.</li>
</ol>

### get Data functions {.tabset}
#### getClimNOAA()
<b style="color:red;">Note that this function now lives in climateNETN package</b>. Extracts gridded NOAA climate data for park centroids. After looking over Daymet, Prism and weather station data, I've settled on the NOAA gridded data to make comparisons because they use the same algorithm and scale to calculate historic averages and annual data. Historic averages are available for the 20th century (1901 - 2000), which I also like, and for the latest 30 year normal (1991 - 2020). The normals for NETN park centroids have been compiled and are a data source that exists when you install the waterNETN package (called NETN_clim_norms.rda). This means you don't have to download or summarize the normals every time you want to use them, which speeds up plotting. You can download data as far back as 1951. However, I've also saved time by compiling all of the monthly data from Jan. 1895 - May 2024, and saved this as a dataset for the package called NETN_clim_annual.rda (see code chunk below on how to access this data set). That means you only need to download and compile data for months after May 2024. I have a webalert set for when a new month is posted, and will add that to the annual data as I have time. If I get behind, you can use the getClimNOAA() function to download the new months of data.

I've also updated all of the climate comparison plotting functions to work with the NOAA data. These functions will check for months not included in the NETN_clim_annual, and will download what's available. The plotting functions use getClimNOAA() under the hood to perform this. You're therefore unlikely to need to use the getClimNOAA() function yourself, unless you want to summarize/plot the data not using functions in waterNETN. 

Currently the `getClimNOAA()` function only works for 1 year at a time, which should be fine, because I've already compiled 1895 - May 2024 data. New data availability is usually delayed by about 2 weeks after a month ends. For example, on 6/16/2024, the data for May 2024 were posted as final. If you try to download data for a month before it's available, you'll get an error telling you which months are not available yet. You then just need to change your `months` argument to include only the months that didn't fail. 

The more months you include in the function, the longer it will take, as each month and climate variable is a separate raster to download. Number of parks minimally impacts performance.

<p class = 'fxn'> get weather data for January - May 2024 for all NETN. </p>
This may take a minute or so to download. If you're ultimately interested in plotting the data using one of the waterNETN package functions, don't worry about downloading separately. Just run the function, and it will run this function under the hood for months not already compiled. 
```{r cache = T}
netn_jan_may <- climateNETN::getClimNOAA(months = 1:5)
print_head(netn_jan_may)
```

<p class = 'fxn'>Get weather data for May 2024 for ROVA</p>
```{r cache = T}
rova_may <- climateNETN::getClimNOAA(park = "ROVA", months = 5)
head(rova_may)
```

<p class = 'fxn'>Get weather data for all of 2023 in LNETN</p>
```{r cache = T}
lnetn_2023 <- climateNETN::getClimNOAA(park = "LNETN", year = 2023, months = 1:12)
print_head(lnetn_2023)
```

<p class = 'fxn'>View dataset containing 1895 - 2024 NOAA climate data</p>
```{r}
library(climateNETN)
data("NETN_clim_annual")
print_head(NETN_clim_annual)

```

#### getClimDaymet()
<b style="color:red;">This function now lives in climateNETN. This function is no longer the primary function to get climate data, but instead climateNETN::getClimNOAA() is the main function.</b>. 

Daymet data are 1km gridded daily climate data, similar to PRISM data, but with more daily data associated with each location and more efficient downloading process (extract data from lat/long points, rather than download nationwide raster files and extract manually). Daymet data go back to 1980. See <a href="https://daymet.ornl.gov/">https://daymet.ornl.gov/</a> for more information. Another benefit of Daymet over PRISM is the data can be used to calculate drought indices, like Standardized Precipitation-Evapotranspiration Index (SPEI). Note: I'll eventually add SPEI metrics to the output of this function. 

Daymet data are typically available for a calendar year a a few months into the next year.

In climateNETN, you can download Daymet data by park centroid and spanning years 1980 to 2023. See examples below. The larger the number of parks and years, the longer it can take. 

<p class = 'fxn'>The following code downloads Daymet data for MORR for the entire monitoring period.</p>
```{r, eval = F}
morr<- climateNETN::getClimDaymet(site = "MORR", years = 2006:2023)
print_head(morr) # table of first 6 rows- this is a custom function I wrote to save on coding
```

<p class = 'fxn'>The following code downloads Daymet data for MABI for 2023. Results are assigned to R session environment and not exported to data folder in the working directory.</p>
```{r, eval = F}
# Daymet data for the MABI for 2023, but not exporting to disk.
mabi_dm <- getClimDaymet(park = "MABI", years = 2023)
print_head(mabi_dm)
```

#### getClimWStat()
<b style="color:red;">This function now lives in the climateNETN package.</b>. 

For each NETN monitoring site, I used the `rnoaa` package to find all weather stations within 20km radius of each site's lat/long coordinates. I then checked the period of record for each of these sites. I selected the closest weather station with the longest period of record that included 2023 and 2024. This assessment was done at the park level, so the data for each site within a park is the same. The API used to download weather station data is <a href="data.rcc-acis.org">data.rcc-acis.org</a>. Unfortunately only temperature data are available for ACAD's McFarland Hill weather station (AKA MARS). ACAD's hourly precipitation data were downloaded separately from the NADP website <a href="http://nadp2.slh.wisc.edu/siteOps/ppt/">http://nadp2.slh.wisc.edu/siteOps/ppt/</a>. These data only go back to 2008 and were aggregated to daily total precipitation. This function is slower for ACAD as a result. Though note that data are downloaded at the park level, then joined with site-specific data. In other words, data are downloaded for a park x combination of years once, then joined to site-level data. Weather stations used and their distance from each site are included in the output.

<p class = 'fxn'>The following code downloads weather station data for ROVA in the past 10 years and writes to a csv.</p>
```{r eval = F}
rova_ws <- climateNETN::getClimWStat(park = "ROVA", years = 2013:2023, export = T, 
                        filepath = "./data")
print_head(rova_ws)
```

```{r echo = F, eval = F}
rova_ws <- climateNETN::getClimWStat(park = "ROVA", years = 2013:2023, export = T, 
                        filepath = "../data")
print_head(rova_ws)
```

```{r echo = F, include = F, eval = F}
file.remove("../data/Weather_station_data_2013-2023.csv")
```
<p class = 'fxn'>The following code downloads weather station data for ACAD in 2023, but doesn't export to disk.</p>
```{r eval = F}
acad_ws <- climateNETN::getClimWStat(park = "ACAD", years = 2023)
print_head(acad_ws)
```

#### getClimDrought()
<b style="color:red;">This function now lives in climateNETN R package</b>.This function downloads weekly drought index at the county level based on the U.S. Drought Monitor for each specified park. If downloading for multiple parks and multiple weeks/years, function may be slow. Returned data frame includes percent of county area in 5 levels of drought, with D0 = Abnormally Dry, D1 = Moderate Drought, D2 = Severe Drought, D3 = Extreme Drought, and D4 = Exceptional Drought. Also returned is the Drought Severity and Coverage Index, which ranges from 0 to 500, and is a weighted sum of area within each of the drought categories. A score of 500 indicates the entire area is in exceptional drought (D4). Where multiple counties occur in a park, data can be faceted by county if `dom_county = FALSE`. To only plot predominant county, specify dom_county = TRUE (default). Otherwise, only park-level data are returned, as the results won't vary by site within a park. Note that Drought Monitor reports data such that, when drought a level moves into a higher category (e.g. D1 = 10), the previous level (e.g. D0) is listed as 100. The columns with pct (e.g. D0pct) correct for that, so that D0 + ... + D05 + None = 100.For more info on the data, see <a href= "https://droughtmonitor.unl.edu/CurrentMap.aspx"><US Drought Monitor</a>

<p class='fxn'> Get drought info for MABI and SAGA sites for first week of May</p>
```{r}
mabisaga <- climateNETN::getClimDrought(park = c("MABI", "SAGA"), week_start = "05/01/2024")
print_head(mabisaga)
```

<p class='fxn'>Get drought info for both counties in MORR in 2023</p>
```{r}
morr <- climateNETN::getClimDrought(park = "MORR", years = 2023, dom_county = TRUE)
print_head(morr)
```

#### getSites() {.tabset}
##### getSites()
Query site-level data. This function combines columns in common between the Sites_Stream and Sites_Lake views. This is a good building block for other functions, but may be less helpful on its own. Though, one helpful use of this function is to get the site codes for a given park or site.

<p class = 'fxn'>Get site info for ACAD lakes</p>
```{r}
ACAD_lakes <- getSites(park = "ACAD", site_type = "lake")
```

<p class = 'fxn'>Get site info for the Pogue</p>
```{r}
pogue <- getSites(site = "MABIPA")
```

<p class = 'fxn'>List site codes and their full site name for SARA</p>
```{r}
sara_sites <- getSites(park = "SARA") |> select(SiteCode, SiteName)
print_head(sara_sites)
```

##### getSitesLake()
Query site-level data for lakes only. This returns lake-only columns in the Sites_Lake views
<p class = 'fxn'>Get site info for ACAD lakes</p>
```{r}
ACAD_str <- getSitesLake(park = "ACAD")
print_head(ACAD_str)
```

<p class = 'fxn'>Get all site info for the Pogue Pond</p>
```{r}
pogue <- getSitesLake(site = "MABIPA", output = 'verbose')
print_head(pogue)
```

##### getSitesStream()
Query site-level data for streams only. This returns stream-only columns in the Sites_Stream views
<p class = 'fxn'>Get site info for ACAD streams</p>
```{r}
ACAD_str <- getSitesStream(park = "ACAD")
print_head(ACAD_str)
```

<p class = 'fxn'>Get all site info for the Pogue Stream</p>
```{r}
poguestr <- getSitesStream(site = "MABISA", output = 'verbose')
print_head(poguestr)
```

#### getEvents()
Query water data by park, site, site_type, year and month. 

<p class = 'fxn'>Get event info for Witch Hole Pond in ACAD in 2023</p>
```{r}
ACAD_lakes <- getEvents(site = "ACWHOL", years = 2023)
print_head(ACAD_lakes)
```

<p class = 'fxn'>Get event info for all years in the Pogue</p>
```{r}
pogue <- getEvents(site = "MABIPA", years = 2006:2023)
print_head(pogue)
```

<p class = 'fxn'>Get date of sampling each site in lower NETN in May, 2023</p>
```{r}
lnetn_evs <- getEvents(park = "LNETN", years = 2023, months = 5) |> 
  select(SiteCode, SiteName, EventDate)
print_head(lnetn_evs) #just printing first 6 rows
```

#### getChemistry()
This function allows you to query the Chemistry_Data view by park, site, site type, year, month, parameter, and sample type. The returned data frame is long (i.e. stacked) to facilitate data summary and plotting. Note that sample depth is not a filter in getChemistry() as it is with the Sonde In Situ data. 

<p class = 'fxn'>Get N parameters for all sites and non-QAQC events in MIMA.</p> 
Note that `QC_type = "ENV"` is the default for this function, which returns only non-QAQC events. Note also the use of named objects for the arguments. This allows you to set them at the top of a script, rather than having to type them out repeatedly. You can then change them in 1 place (i.e., update the year to 2024) and rerun the code. 
```{r}
n_params <- c("NH3", "NH3_mgL", "NO2", "NO2_mgL", "NO2+NO3", 
              "NO2+NO3_mgL", "NO3", "NO3_ueqL", "TN", "TN_mgL")
period <- 2006:2023
mima_n <- getChemistry(park = "MIMA", years = period, parameter = n_params)
print_head(mima_n) # top 6 rows
```

<p class = 'fxn'>Get results for all surface samples, including QC samples, in Browns Brook in 2023 in ACAD</p>
```{r}
brbk <- getChemistry(site = "ACBRWN", QC_type = "all", param = "all", 
                     years = 2023)
print_head(brbk)
```

<p class = 'fxn'>Get ANC for LNETN parks for all years during month of May. Note that by not specifying years, all years by default will be included in the output.</p>
```{r}
anc <- getChemistry(park = "LNETN", param = "ANC", months = 5)
print_head(anc)
```

<p class = 'fxn'>Get  for ACAD lakes from 2021:2023 from all sample depths.</p>
```{r}
surf <- getChemistry(park = "ACAD", site_type = "lake", years = 2021:2023)
print_head(surf)
```

<p class = 'fxn'>Get censored and non-censored NH3 data for LNETN all years. Note the Flag column indicates the measurement is censored by reporting the detection limit used.</p>
```{r}
cens <- getChemistry(park = "LNETN", param = "NH3", include_censored = TRUE)
print_head(cens) 
```

#### getDischarge()
This function allows you to query the Discharge_Data view by park, site, site type, year, month, measurement method (e.g., flowtracker or pygmy), and measurement rating (e.g., E, G, F, P). Note that you can also return all columns or a reduced set of columns with the output argument. Default is output = 'short'. This function is set up to work with site_type = 'stream', so you don't have to specify that.

<p class = 'fxn'>Get discharge data for all LNETN sites and years measured with flowtracker </p>
```{r}
ft <- getDischarge(park = "LNETN", method = "Pygmy")
print_head(ft)
```

<p class = 'fxn'>Get discharge data for all ACAD streams with measurement rating of Excellent or Good </p>
```{r}
acad <- getDischarge(park = "ACAD", rating = c("E", "G"))
str(acad) # structure of returned data
```

#### getLightPen()
This function allows you to query the Light_Penetration_Data view by park, site, site type, year, and month. Again output = 'short' is the default. If specify output = 'verbose', you'll get all possible columns. This is only set up to work with site_type = 'lake', so you don't have to specify that.

<p class = 'fxn'>Get light penetration for Weir Pond from 2013 - 2023 all months.</p> 
```{r}
period <- 2013:2023
wefa <- getLightPen(park = "WEFA", years = period)
print_head(wefa) # top 6 rows
```

<p class = 'fxn'>Get light penetration for ACAD lakes in 2023 in July and August.</p> 
```{r}
acad <- getLightPen(park = "ACAD", years = 2023, months = 7:8)
print_head(acad) # top 6 rows
```

#### getSecchi()
This function allows you to query Secchi data by park, site, site type, years, months and whether you want to return all observations, the first or the second. Default returns all observations with data. Note that this function is designed to only work with lakes, and doesn't require site_type = "lake" to be specified.
<p class = 'fxn'>Get Secchi depth the Pogue from 2021-2023, first observer only</p>
```{r}
mabi <- getSecchi(site = "MABIPA", years = 2021:2023, observer_type = "first")
print_head(mabi)
```

<p class = 'fxn'>Get Secchi for all ACAD lakes sampled in July for all observers
```{r}
ACAD_lake <- getSecchi(park = 'ACAD', months = 7)
print_head(ACAD_lake)
```

#### getSondeInSitu()
This function allows you to query Sonde in situ data by park, site, site type, years, months, parameter, QC type, surface vs. all, etc. Default returns all non-QAQC observations with data. The Sonde_InSitu_Data view is large and can take a few seconds to run for most parks, sites, years, parameters, etc. Surface only measurements, defined as as the medium of all samples within 2m of the surface, are the default.

<p class = 'fxn'>Get Sonde data for all sites and parameters in MABI from 2021-2023 for non-QAQC samples</p>
```{r}
mabi <- getSondeInSitu(park = "MABI", years = 2021:2023)
print_head(mabi)
```

<p class = 'fxn'>get data for all DO parameters in MIMA from 2006-2023 for non-QAQC samples</p>
```{r}
params <- c("DOsat_pct", "DOsatLoc_pct", "DO_mgL")
period <- 2006:2023
mima_do <- getSondeInSitu(park = "MIMA", years = period, parameter = params)
print_head(mima_do)
```

<p class = 'fxn'>Get Temp data for all sample depths in Jordan Pond in ACAD for non-QAQC samples</p>
```{r}
ACAD_lake <- getSondeInSitu(site = 'ACJORD', parameter = "Temp_C", 
                            sample_depth = "all")
```

<p class = 'fxn'>Get pH for lower NETN parks from May to Oct for QAQC and non-QAQC samples</p>
```{r}
lnetn_ph <- getSondeInSitu(park = "LNETN", param = "pH", months = 5:10, 
                           QC_type = 'all')
```

#### getStreamObs()
This function allows you to query stream observation data by park, site, year and month
<p class = 'fxn'>Get stream observations for Pogue Stream all years</p>
```{r}
mabi <- getStreamObs(park = "MABI")
print_head(mabi)
```
<p class = 'fxn'>Get observations for all streams in ACAD May 2023 </p>
```{r}
ACAD_streams <- getStreamObs(park = 'ACAD', years = 2023, months = 5)
print_head(ACAD_streams)
```

#### getWaterLevel()
This function joins stage and water level data, and allows you to query by park, site, site_type, year, and month. Note that WL data start in 2013 in the view. 

<p class = 'fxn'>Get water level data for Bubble Pond. </p>
```{r}
bubl <- getWaterLevel(site = "ACBUBL", years = 2013:2023)
print_head(bubl)
```

<p class = 'fxn'>Get water level data for Weir Pond in August. </p>
```{r}
weir <- getWaterLevel(site = "WEFAPA", months = 8)
print_head(weir)
```

### Plotting Functions {.tabset}
#### plotWaterBands()
This function produces a plot that summarizes the range of historic data compared with current measurements. The function can handle chemistry, Sonde in situ, Secchi depth, Light Penetration, and Discharge data, although it functions best with sonde and chemistry data. Historic measurements are displayed as the min-max values ever previously recorded (outermost band), upper and lower 95% distribution and middle 50% distribution (inner quartiles) of values previously recorded (inner bands). The line represents the median value.

Currently you can only specify one parameter at a time. Values that exceed water quality thresholds (where they exist) are plotted as orange and will show an orange point in the legend. Values within WQ thresholds or for parameters without set thresholds are black. You can include threshold lines (default), or remove them, where they make the y axis range too big, via `threshold = FALSE`. If multiple sites are specified, they will be faceted.

You can now add gridlines to the plot via the gridlines argument, and Temp in F via "Temp_F" argument. 

<p class = 'fxn'>Plot pH in Jordan Pond for 2023 with gridlines on the y-axis</p>
```{r message = FALSE, warning = FALSE}
plotWaterBands(site = "ACJORD", year_curr = 2023, years_historic = 2006:2022, 
  parameter = "pH", legend_position = 'right', gridlines = 'grid_y')
```

<p class = 'fxn'>Plot TN in Jordan Pond for 2023, including censored and gridlines on both x and y axes</p>
```{r message = FALSE, warning = FALSE}
plotWaterBands(site = "ACJORD", year_curr = 2023, years_historic = 2006:2022,
  parameter = "TN_mgL", legend_position = 'right', include_censored = T, gridlines = "both")
```

<p class = 'fxn'>Same as above, but drop threshold lines and add gridlines on x-axis</p>
```{r message = FALSE, warning = FALSE}
plotWaterBands(site = "ACJORD", year_curr = 2023, years_historic = 2006:2022,
  parameter = "TN_mgL", legend_position = 'right', include_censored = T, threshold = F, gridlines = "grid_x")
```

<p class = 'fxn'>Plot Temp in F in SARA sites in 2023 without gridlines (default)</p>
```{r message = FALSE, warning = FALSE}
plotWaterBands(park = "SARA", year_curr = 2023, years_historic = 2006:2022, parameter = "Temp_F",
  legend_position = 'right')
```

#### plotScatterPlot()
This function produces points or loess smoothed lines of 2 variables, filtered on park, site, year, month, and 2 parameters. Works with lab chemistry, Sonde in situ, discharge, secchi depth, water level, and light penetration ratio. If multiple sites are specified, they will be plotted on the same figure, unless facet_site = T. Note that if you specify a site and parameter combination that doesn't exist (e.g., a stream site and a parameter only collected in lakes), the function will return an error message instead of an empty plot. Censored values are not permitted in this function.

<p class = 'fxn'>Plot Temp vs DO for ROVA all years on same figure</p>
```{r message = FALSE, warning = FALSE}
plotScatterPlot(park = "ROVA", parameters = c("DO_mgL", "Temp_C"),
  palette = 'viridis', facet_site = F, legend_position = "bottom")

```

<p class = 'fxn'>Plot Secchi depth vs. surface DOC in Eagle Lake, Jordon Pond, Echo Lake, and Witch Hole Pond</p>
```{r message = FALSE, warning = FALSE}
plotScatterPlot(site = c("ACEAGL", "ACJORD", "ACWHOL", "ACECHO"), parameters = c("SDepth_m", "DOC_mgL"),
  span = 0.9, facet_site = F, legend_position = 'bottom', palette = c("red", "orange", "purple4", "blue"))
```


<p class = 'fxn'>Same as above, but points only </p>
```{r message = FALSE, warning = FALSE}
plotScatterPlot(site = c("ACEAGL", "ACJORD", "ACWHOL", "ACECHO"), parameters = c("SDepth_m", "DOC_mgL"),
  span = 0.9, facet_site = F, legend_position = 'bottom', layers = 'points')
```

<p class = 'fxn'> Plot smoothed discharge vs. specific conductance for the Pogue Brook using span of 0.9, and green symbols. </p>
```{r message = FALSE, warning = FALSE}
plotScatterPlot(site = "MABISA", parameters = c("SpCond_uScm", "Discharge_cfs"), span = 0.9, palette = c("forestgreen"))
```

<p class = 'fxn'> Plot smoothed discharge vs. specific conductance for SARA streams using span of 0.9. </p>
```{r message = FALSE, warning = FALSE}
plotScatterPlot(park = "SARA", parameters = c("SpCond_uScm", "Discharge_cfs"), span = 0.9, facet_site = F,
  legend_position = 'bottom', palette = c("blue", "orange"))
```

<p class = 'fxn'> Same as above, but faceted by site.</p>
```{r message = FALSE, warning = FALSE}
plotScatterPlot(park = "SARA", parameters = c("SpCond_uScm", "Discharge_cfs"), span = 0.9, facet_site = T)
```

<p class = 'fxn'>Plot TN vs discharge in SARA streams</p>
```{r message = FALSE, warning = FALSE}
plotScatterPlot(park = "SARA", parameters = c("TN_mgL", "Discharge_cfs"), span = 0.9, facet_site = F)
```

#### plotTrend()
This function produces a trend plot filtered on park, site, year, month, and parameter.
It works with chemistry, Sonde in situ, Secchi depth, Light Penetration, and Discharge data. If multiple sites are specified, they will be plotted on the same figure. If multiple parameters are specified, they will be plotted on separate figures. If smooth = T, a loess smoothed line will connect through the data. If smooth = F and layers includes "lines", then lines will connect the sample points, but will not connect across years, because of the break between October and May.

There are several arguments to customize plots. 
<ul>
<li> Choose whether to include only active sites (default) or all sites that have been monitored via `active`. </li>
<li> Choose whether to add points, lines, or both (default) via `layers` argument. </li>
<li> If lines are chosen as a layer, choose whether to plot a loess smoothed line (default) or a line that connects the sample points via `smooth`. </li>
<li> Choose whether to plot any water quality thresholds that exist via `threshold`. Upper limits are dashed. Lower limits are dotted. </li>
<li> Choose whether to add gridlines, either both, grid_y or grid_x. Default is none. </li>
<li> Choose whether to plot surface (default) or all depth measurements via `sample_depth`. </li>
<li> Choose whether to include censored values or not via `include_censored`. </li>
<li> Choose color palette via `palette`. Default is 'viridis', but other options are magma (yellow, red, purple), plasma (brighter version of magma), turbo (rainbow), or specify a vector of colors manually. See the <a href='https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html'>intro do viridis site</a> for more info on built in color palettes. </li>
<li> Choose position of legend via `legend_position`. If you don't want to show the legend, `legend_position = 'none'`.</li>
<li> Plot temperature in F via `parameter = "Temp_F"`.</li>
<li> Additional customizations are defined in the help documentation, accessable via `?plotTrend()`</li>
</ul>

<details open><summary class='drop'>Single site; single parameter</summary>
<p class = 'fxn'>Plot non-smoothed surface pH for Eagle Lake for all years with gridlines on y-axis. </p>
```{r message = FALSE, warning = FALSE}
plotTrend(site = "ACEAGL", parameter = "pH", smooth = FALSE, gridlines = 'grid_y')

```

<p class = 'fxn'>Plot smoothed surface pH for Eagle Lake for past 3 years using default span of 0.3 and by default not including the legend. </p>
```{r message = FALSE, warning = FALSE}
plotTrend(site = "ACEAGL", parameter = "pH", palette = 'dimgrey', years = 2021:2023)

```
<p class = 'fxn'>Plot smoothed surface pH for Eagle Lake and Jordan Pond for all years, with turbo palette, and using span of 0.75. </p>
```{r message = FALSE, warning = FALSE}
plotTrend(site = c("ACEAGL", "ACJORD"), parameter = "pH", span = 0.75, palette = "turbo", legend_position = 'bottom')

```

<p class = 'fxn'>Plot smoothed Secchi Depth in Jordan Pond for all years, including the legend, different color palette, and using span of 0.75. </p>
```{r message = FALSE, warning = FALSE}
plotTrend(site = "ACJORD", parameter = "SDepth_m", span = 0.75, palette = 'mako')

```

<p class = 'fxn'>Plot unsmoothed SO4 in Witch Hole Pond for all years, including censored values. </p>
```{r message = FALSE, warning = FALSE}
plotTrend(site = "ACWHOL", parameter = "SO4_ueqL", 
          smooth = F, include_censored = TRUE, legend_position = 'bottom')

```

<p class = 'fxn'>Plot unsmoothed line only for pH in Witch Hole Pond for all years. </p>
```{r message = FALSE, warning = FALSE}
plotTrend(site = "ACWHOL", parameter = "pH", layers = "lines", 
          smooth = F, legend_position = 'none')

```


</details>

<details open><summary class='drop'>Multiple sites or params</summary>
<p class = 'fxn'>Plot smoothed surface pH for active SARA streams over all years with 0.6 span and convert to plotly. Note that plotly figures don't seem to display in the current version of RStudio (2024.04.2), but they do render when knit with R Markdown to an html file. </p>
```{r message = FALSE, warning = FALSE}
p <- plotTrend(park = "SARA", site = c("SARASA", "SARASC", "SARASD"), 
               site_type = "stream", parameter = "pH", 
               legend_position = "right", span = 0.6)

```

<p class = 'fxn'>Plot smoothed surface Specific Conductance for all MIMA streams over all years with 0.6 span. </p>
```{r message = FALSE, warning = FALSE}
plotTrend(park = "MIMA", site_type = "stream", 
          parameter = "SpCond_uScm", legend_position = "right", span = 0.6, palette = c("blue", "orange", "green3"))

```

<p class = 'fxn'>Plot non-smoothed surface of multiple Sonde parameters for all MIMA streams over all years with 0.6 span. Note that here I used Temp_F. </p>
```{r message = FALSE, warning = FALSE}
params <- c("Temp_F", "SpCond_uScm", "DOsat_pct", "pH")
plotTrend(park = "MIMA", site_type = "stream", 
          parameter = params, legend_position = "right", span = 0.6)

```

<p class = 'fxn'>Plot smoothed surface Secchi Depth, Specific Conductance, pH, and DOC in Jordan Pond for all years, including the legend, different color palette, and using span of 0.75. </p>
```{r message = FALSE, warning = FALSE}
plotTrend(site = "ACJORD", parameter = c("SDepth_m", "SpCond_uScm", "pH", "DOC_mgL"), 
          span = 0.75, palette = 'mako')

```

<p class = 'fxn'>Plot smoothed surface water depth in the Pogue for all years, including a different color palette, and using span of 0.75. </p>
```{r message = FALSE, warning = FALSE}
plotTrend(site = "MABIPA", parameter = "WaterLevel_Feet", span = 0.75, 
          palette = 'mako')

```

<p class = 'fxn'>Plot smoothed TN, TP and SO4 in all MORR sites for all years, including the legend, different color palette, and using span of 0.6. Thresholds, where they exist,  plot by default.</p>
```{r message = FALSE, warning = FALSE}
plotTrend(park = "MORR", parameter = c("TN_mgL", "TP_ugL", "SO4_ueqL"), 
          span = 0.6, legend_position = 'bottom', palette = 'plasma')
```

</details>

#### plotLakeProfile()
This function produces a heatmap in 1-m bins for ACAD and 0.25m bins for LNETN. You can filter on park, site, year, month, Sonde in situ parameter and either sample relative to the surface or relative to surface elevation. You can only specify one parameter at a time. If multiple sites or years are selected, plots will be faceted on those factors. Keep options limited for best plotting. Note also that you can either select ACAD or LNETN parks, because of the differences in binning.

The option to plot relative to surface elevation (eg depth_type = 'elev') corrects sample depth for elevation using water level data and datum elevation for that sampling event. The elevation-corrected option allows you to see how the water column is shifting over time, but currently only works for years >= 2013 in ACAD, as water levels prior to that are not in the current data package. Default setting is raw, where the raw sample depths are plotted instead of elevation.

Note that occasionally profiles skip a bin, which show up as white sections in the plots. Incomplete sampling in 2020 and 2021 also shows up as white sections. If you specify a lake x year x parameter combination that doesn't exist (e.g., a year a lake isn't sampled), the function will return an error message instead of an empty plot.

The width of the profiles take into account the number of days between sampling events. For the first and last months (typically May and October), the left/right side of the profiles are padded by 14 days. Otherwise, profile widths are centered on the sample day with the left side representing half the number of days between that visit and the previous visit and the right side representing half the number of days between that visit and the following visit. Black lines are the thermocline, as calculated by rLakeAnalyzer.  

There are several arguments to customize plots. 
<ul>
<li>Choose whether to plot the theromocline as points on each profile via `plot_thermocline = TRUE` (default). The thermocline is calculated by rLakeAnalyzer, and is the depth/elevation at which the largest change in temperature occurs in the sampled water column. If no thermocline is detected, as defined by `rLakeAnalyzer::thermo.depth()`, nothing is plotted.</li>
<li>Choose whether to include only active sites (default) or all sites that have been monitored via `active`. </li>
<li>Add gridlines on the y, x or both axes.</li>
<li>Choose palette. Current enabled themes are 'viridis' (yellow - green - blue), and built in continuous color patterns in RColorBrewer. If you prefer other palettes, I can add those too. The only thing I'm trying to avoid is creating the palette manually, since number 1-m bins varies by site and across years. More info on built in ggplot scales can be found here: <a href="https://ggplot2-book.org/scales-colour">https://ggplot2-book.org/scales-colour</a>. </li>
<li>Choose position of legend via `legend_position`. If you don't want to show the legend, `legend_position = 'none'`.
<li>Include site name as plot title (title = TRUE). Only enabled when 1 site is selected. Otherwise site names will be in the facets.
<li> Plot temperature in F via `parameter = "Temp_F"`.</li>
</ul>

<details><summary = 'drop'>Continuous RColorBrewer palettes are below. Note that there are only as many colors as shown. </summary>
```{r }
RColorBrewer::display.brewer.all(type = 'div')
RColorBrewer::display.brewer.all(type = 'seq')

```
</details><br>

<details open><summary class='drop'>Simple plots</summary>
<p class = 'fxn'>Plot temperature (in F) for Upper Hadlock for years 2013 - 2023 corrected by elevation with thermocline plotted as black lines, with gridlines on y. </p>
```{r message = FALSE, warning = FALSE}
plotLakeProfile(site = "ACUHAD", parameter = "Temp_F", depth_type = 'elev', 
                years = 2013:2023, gridlines = "grid_y")

```

<p class = 'fxn'>Plot temp (in C) using raw sample depth (default) for all LNETN lakes sampled in 2023.</p>
```{r message = FALSE, warning = FALSE}
plotLakeProfile(park = "LNETN", parameter = "Temp_C", years = 2023, palette = "Spectral")

```

<p class = 'fxn'>Plot temperature for Eagle Lake for years 2006 - 2023 with raw sample depth. Note that we can go back to 2006 because we're using raw sample depth instead of elevation.</p>
```{r message = FALSE, warning = FALSE}
plotLakeProfile(site = "ACEAGL", parameter = "Temp_C", depth_type = 'raw', 
                years = 2006:2023)

```

<p class = 'fxn'>Same plot as above, but with no plot title or thermocline. 
```{r message = FALSE, warning = FALSE}
plotLakeProfile(site = "ACEAGL", parameter = "Temp_C", depth_type = 'raw', 
                years = 2006:2023, plot_title = FALSE, plot_thermocline = F)

```

<p class = 'fxn'>Plot temperature for all ACAD lakes sampled in 2023 and raw sample depth. </p>
```{r message = FALSE, warning = FALSE}
lakes23 <- c("ACBUBL", "ACEAGL", "ACECHO", "ACJORD", "ACLONG", "ACROUN", 
             "ACSEAL", "ACUBRK", "ACUHAD", "ACWHOL")
plotLakeProfile(park = "ACAD", site = lakes23, parameter = "Temp_C", 
                depth_type = 'raw', years = 2023)

```

<p class = 'fxn'>Plot DO all ACAD lakes sampled in 2023 and raw sample depth, using reversed RdYlBu palette. Temperature thermocline is also included as black lines.</p>
```{r message = FALSE, warning = FALSE}
plotLakeProfile(park = "ACAD", site = lakes23, 
                parameter = "DOsat_pct", depth_type = 'raw', years = 2023, 
                palette = 'RdYlBu', color_rev = TRUE)

```

<p class = 'fxn'>Plot specific conductance for Seal Cove Pond from 2013 to 2023 and sample elevation. Uses spectral palette by default and adds site name as title by default. Thermocline is also plotted as default. </p>
```{r message = FALSE, warning = FALSE}
plotLakeProfile(site = "ACSEAL", parameter = "SpCond_uScm", 
                depth_type = 'elev', years = 2013:2023)

```

<p class = 'fxn'>Plot pH for Jordan Pond from 2013 to 2023 and sample elevation, using reversed spectral palette. </p>
```{r message = FALSE, warning = FALSE}
plotLakeProfile(site = "ACJORD", parameter = "pH", 
                depth_type = 'elev', years = 2013:2023, 
                color_rev = TRUE)

```

<p class = 'fxn'>Plot pH for all ACAD lakes sampled in 2022 and 2023 and raw sample depth, using reversed RdYlBu palette. </p>
```{r message = FALSE, warning = FALSE}
plotLakeProfile(park = "ACAD", site = c("ACBUBL", "ACEAGL", "ACECHO", "ACJORD", "ACLONG", "ACSEAL", 
                                        "ACUHAD", "ACWHOL"), 
                parameter = "pH", depth_type = 'raw', years = 2022:2023, 
                palette = 'RdYlBu', color_rev = TRUE)

```

</details>
<br>

<details open><summary class='drop'>Combining plots</summary>
<p class = 'fxn'>Combine plots for temp, DO, pH, and conductance in Bubble Pond for 2023 using the `cowplot` package.</p>
To minimize typing, I define the parameters I wanted at the beginning. This allows you to adjust the parameters once (i.e., change site), and run through the rest of the code without having to edit it. I also only included the plot title on the first figure, and turned it off for the rest.

The `cowplot` package must be installed to use this code. Install the package via `install.packages('cowplot')`. There are other packages to combine plots, including `grid` and `gridExtra`, and the function `ggarrage()` in `ggpubr`. I tend to start with cowplot, because it's easy to use and has a great <a href="https://wilkelab.org/cowplot/">help page</a>. If I really need to customize a plot (like custom spacing for each plot), then I use `grid/gridExtra`, which allows for more customization, but is a bit harder to work with.  
```{r message = FALSE, warning = FALSE}
library(cowplot)
sitecode = "ACBUBL"
sitename = getSites(site = sitecode)$SiteName
year = 2023
mon = 5:10
depth = 'elev'
ptitle = F

tplot <- plotLakeProfile(site = sitecode, parameter = "Temp_C", depth_type = depth,
                         years = year, months = mon, plot_title = ptitle)

doplot <- plotLakeProfile(site = sitecode, parameter = "DOsat_pct", depth_type = depth,
                          years = year, months = mon, color_rev = T, plot_title = ptitle)

pHplot <- plotLakeProfile(site = sitecode, parameter = "pH", depth_type = depth,
                          years = year, months = mon, palette = "RdYlBu", color_rev = T,
                          plot_title = ptitle)

cnplot <- plotLakeProfile(site = sitecode, parameter = "SpCond_uScm", depth_type = depth,
                         years = year, months = mon, palette = 'RdBu',
                         plot_title = ptitle)

# Default settings
plot_grid(tplot, doplot, pHplot, cnplot)
```

<p class = 'fxn'>Same plot as above, but customize plot widths, so DO and SpCond have more space for legend, and add title above the grid.</p>
In this case, we're creating the plot grid with relative widths for each plot. Then we're combining the title and the plot grid in another grid, setting the title height to be much smaller than the plot grid. 

Note that sitename and year are defined in code chunk above.
```{r warning = F, message = F}
title <- ggdraw() + draw_label(paste0(sitename, " (", year, ")"), size = 11, fontface = 'bold',
                               x = 0.05, hjust = 0, vjust = 0) 
pgrid <- plot_grid(tplot, doplot, pHplot, cnplot, rel_widths = c(0.9, 0.95, 0.85, 1)) # doesn't seem to be working 
plot_grid(title, pgrid, ncol = 1, rel_heights = c(0.1, 1))
```

</details>

#### plotPrecipDischarge()
This function produces a plot with dual y-axes, one for precipitation and one for discharge. The x-axis is date. This function only works for one stream monitoring site at a time. Note that ggplot tends to have a lot of warnings that are hard to suppress, particularly for this plot, which has a daily value for precipitation and only monthly values for discharge. You're always going to get a message about that by using this function. Function currently only plots years where discharge is collected. Discharge is plotted as points and not lines, because discharge can change a lot between sampling events.

<b style="color:red;">Note that the climateNETN package must be installed for this function to work, as it relies on downloading daily precipitation data.</b> To install run `devtools::install_github("KateMMiller/climateNETN")`

<p class = 'fxn'>Plot Discharge for Mill Brook in MIMA for past 3 years using default colors and gridlines on the y-axis and english units. </p>
```{r message=FALSE, warning=FALSE}
plotPrecipDischarge(site = c("MIMASA"), years = 2021:2023, gridlines = "grid_y", units = "eng")

```
<p class = 'fxn'>Plot Discharge for Aunt Betty Inlet and Kebo Stream for 2022 using different colors. Note that this can be slow because has to download precip. data from NADP. LNETN parks download from a faster web service. </p>
```{r message=FALSE, warning=FALSE}
plotPrecipDischarge(site = c("ACABIN", "ACKEBO"), years = 2022, palette = c("cornflowerblue", "orange"))

```

#### plotClimTrend()
<b style="color:red;">Note that this function now lives in climateNETN package</b>. This function produces a line or a rolling average filtered on park, year, month, and climate parameter. The default rolling average is 5-years, but you can specify a different window with the avg_window argument. If multiple parks are specified, they can either be plotted on the same figure or separate figures. If multiple parameters are specified, they will be plotted on separate figures. For multiple parks to plot on the same figure, use facet_site = FALSE. For multiple parameters on the same figure, facet_param = FALSE. Note that all months (1:12) are default. If you only want sample months, specify months = 5:10.

<b style="color:red;">NEW: I updated the compiled climate data to cover 1895 up through June 2024, so you can plot historic trends beyond just the 2006-2024 monitoring period. You can also plot units in English.</b>

<p class = 'fxn'>Plot avg temp for LNETN from 1895:2024, without points and with 5-year rolling average and gridlines on y-axis, and in English units. Note that avg_window = 5 isn't necessary, since it's the default.</p>
```{r message = F, warning = F}
climateNETN::plotClimTrend(park = "LNETN", years = 1895:2024, layers = 'rollavg',
              parameter = "tmean", palette = c("viridis"), facet_park = T,
              legend_position = 'bottom', gridlines = "grid_y", units = "eng")
```

<p class = 'fxn'>Plot monthly precip for MORR, ROVA and WEFA from 1895:2024, without points and with smoothed line and span 0.1.</p>
```{r message = F, warning = F}
climateNETN::plotClimTrend(park = c("MORR", "ROVA", "WEFA"), years = 1895:2024, layers = 'smooth', 
              parameter = "tmean", span = 0.1, palette = "turbo", legend_position = 'right')
```

<p class = 'fxn'>Plot temp stats from 1895-2024 for ACAD on the same figure. 
```{r message = F, warning = F}
climateNETN::plotClimTrend(park = "ACAD", years = 1895:2024, parameter = c("tmin", "tmean", "tmax"), span = 0.1, layers = 'smooth', facet_param = F, legend_position = 'right', palette = "viridis")
```

<p class = 'fxn'>Plot monthly temperature data in English units for MABI from 2006:2023 (all months is default), with points and a 4-year rolling average.</p>
```{r message = F, warning = F}
climateNETN::plotClimTrend(park = "MABI", years = 2006:2023, parameter = c("tmin", "tmean", "tmax"), 
                           layers = c("points", "rollavg"), 
                           facet_param = T, gridlines = "grid_y", units = 'eng', avg_window = 4)
```
<p class = 'fxn'>Plot same monthly NOAA data for MABI from 2006:2023, with smoothed line and span 0.7, and using the Dark2 color palette.</p>
```{r message = F, warning = F}
climateNETN::plotClimTrend(park = "MABI", years = 2006:2023, parameter = "all", layers = 'smooth', span = 0.7, palette = "magma")
```

<p class = 'fxn'>Plot monthly NOAA min, max and mean temperature for MABI and SARA from 2006:2024, with smoothed line, span 0.7, and parks on separate plots, but parameters on the same plots. </p>
```{r message = F, warning = F}
climateNETN::plotClimTrend(park = c("MABI", "SARA"), years = 2006:2023, 
              parameter = c("tmean", "tmax", "tmin"), 
              layers = 'smooth',
              span = 0.7, facet_park = TRUE, facet_param = FALSE,
              legend_position = "bottom")
```

<p class = 'fxn'>Plot monthly NOAA min, max and mean temperature for MABI 2006:2024, with points and smoothed line, span 0.7 with parameters on the same plots. </p>
```{r message = F, warning = F}
climateNETN::plotClimTrend(park = "MABI", years = 2006:2023, 
              parameter = c("tmean", "tmax", "tmin"),
              layers = c("points", "smooth"),
              span = 0.7, facet_param = F, legend_position = 'bottom')
```


#### plotClimAnom()
<b style="color:red;">Note that this function now lives in climateNETN package</b>. This function produces a trend plot filtered on park, year, month, and climate parameter and shows anomalies from chosen baseline (1901 - 2000 or 1991 - 2020) as red for above and blue for below average using gridded NOAA NClim data. If a year x month combination is specified that doesn't occur yet in NETN_clim_annual dataset, it will be downloaded if available. New months are typically available within a few weeks of the month end. If multiple parks are specified, they can either be plotted on the same figure or separate figures. If multiple parameters are specified, they will be plotted on separate figures.You can also plot percent difference of precipitation, in addition to difference in raw units (i.e. mm). 

<p class = 'fxn'>Plot ACAD average temperature anomalies from 1895 to 2024 compared with 20th century normals with gridlines on y axis and English units.</p>
```{r message = F, warning = F}
climateNETN::plotClimAnom(park = "ACAD", years = 1895:2024, parameter = "tmean", 
             legend_position = 'right', gridlines = "grid_y", units = "eng")
```

<p class = 'fxn'>Plot WEFA percent precipitation anomalies in 2023 compared with 20th century normals.</p>
```{r message = F, warning = F}
climateNETN::plotClimAnom(park = "WEFA", years = 2023, parameter = "ppt_pct", legend_position = 'right')
```


<p class = 'fxn'>Plot MABI and SAGA average temperature anomalies from 2006 to 2024 compared with 20th century normals.</p>
```{r message = F, warning = F}
climateNETN::plotClimAnom(park = c("MABI", "SAGA"), years = 2006:2024, parameter = "tmean", legend_position = 'right')
```
<p class = 'fxn'>Plot MABI and SAGA precip. anomalies from 2023 compared with 20th century normals.</p>
```{r message = F, warning = F}
climateNETN::plotClimAnom(park = c("MABI", "SAGA"), years = 2023, parameter = "ppt", legend_position = 'right')
```

<p class = 'fxn'>Plot ACAD avg temp anomalies from last 20 years compared with 30-year normals.</p>
```{r message = F, warning = F}
climateNETN::plotClimAnom(park = c("ACAD"), years = 2004:2024, parameter = "tmean", 
             legend_position = 'bottom', normal = "norm1990")
```


#### plotClimComps()
<b style="color:red;">Note that this function now lives in climateNETN package</b>. This function compares either the 20th century normals (1901 - 2000), or the most recent 30-year normal (1991 - 2020) average monthly climate variables with user-specified years to provide an idea of how extreme or normal a given month in a year is. 

<b style="color:red;">This function has been overhauled to work with NOAA gridded climate data for both the normals and the current data.</b> The same algorithms are used to generate historic and current data, which minimizes the bias introduced by weather station vs. Daymet data (Prism had similar issues). Using the NOAA dataset is slower to process, so I went with park-level centroids to extract climate data instead of extracting at the site level. I also compiled all of the NOAA data from 1895 through May 2024. I have a webalert that tells me when a new month is available, so I can keep the compiled data up to date (see `data("NETN_clim_annual")`). However, if I get behind, this function will download the missing months of data that are available online. 

You can now add gridlines to x, y, or both axes.

<details open><summary class='drop'>Single parameter</summary>
<p class = 'fxn'>Plot mean monthly temp for MABI for 2019:2023 and all months with red-blue color palette and the 20th century normal with gridlines on y in english units.</p>
```{r message = F, warning = F}
climateNETN::plotClimComps(park = "MABI", years = 2019:2023, parameter = "tmean", 
              palette = c("red", "blue"), normal = "norm20cent",
              gridlines = 'grid_y', units = "eng")
```
<p class = 'fxn'>Same as above, but with points and 30-year normal starting at 1991.</p>
```{r message = F, warning = F}
climateNETN::plotClimComps(park = "MABI", years = 2019:2023, parameter = "tmean", 
                           palette = c("red", "blue"), 
              layers = c('points', 'lines'), normal = "norm1990", units = 'eng')
```
<p class = 'fxn'>Plot max monthly temp for ROVA for 2023 and 2024, with orange-blue palette and 20th century norm (default) using scientific units.</p>

```{r message = F, warning = F}
climateNETN::plotClimComps(park = "ROVA", years = 2023:2024, parameter = "tmax", 
              palette = c("orange", "blue"), layers = 'lines')
```
<p class = 'fxn'>Plot total monthly precip for Jordan Pond for past 5 years using orange-blue color palette, compared with the 30-year norm starting at 1990.</p>
```{r message = F, warning = F}
climateNETN::plotClimComps(park = "ACAD", years = 2018:2023, parameter = 'ppt', 
              palette = c("orange","blue"), normal = "norm1990")
```

<p class = 'fxn'>Plot total monthly precip for ACAD for current year using red for 2023 and blue for 2024</p>
```{r message = F, warning = F}
climateNETN::plotClimComps(park = "ACAD", years = 2023:2024, parameter = 'ppt', palette = c("red", "blue"))
```

<p class = 'fxn'>Plot total monthly max temp for ACAD for current year using red for current year color and 30-year normal.</p>
```{r message = F, warning = F}
climateNETN::plotClimComps(park = "ACAD", years = 2024, parameter = 'tmax', palette = c("red"), normal = "norm1990")
```

</details><br>

<details open><summary class = 'drop'>Multiple plots</summary>

The code below would take a lot to program into waterNETN functions, so I'm instead showing you how you can create panels of multiple plots using the cowplot package. 

<p class = 'fxn'>Generate grid of all parameters in ACAD from past 5 years</p> 
Note that the code that names leg is extracting a legend from a copy of the figures to be plotted separately from the other figures. This allows you to control the sizing and alignment better. The NULLs also allow you to create white space between plots.
```{r message = F, warning = F}
tmax <- climateNETN::plotClimComps(
  park = "ACAD", years = 2019:2023, parameter = "tmax",
  layers = 'lines', legend_position = 'none', palette = c("red", "blue"))

tmin <- climateNETN::plotClimComps(
  park = "ACAD", years = 2019:2023, parameter = "tmin", 
  layers = 'lines', legend_position = 'none', palette = c("red", "blue"))
tmean <- climateNETN::plotClimComps(
  park = "ACAD", years = 2019:2023, parameter = "tmean",  
  layers = 'lines', legend_position = 'none', palette = c("red", "blue"))
prec <- climateNETN::plotClimComps(
  park = "ACAD", years = 2019:2023, parameter = 'ppt', 
  layers = 'lines', legend_position = 'none', palette = c("red", "blue"))

prec_leg <- climateNETN::plotClimComps(park = "ACAD", years = 2019:2023, parameter = 'tmax', 
                          layers = 'lines', legend_position = 'right', palette = c("red", "blue")) +
 theme(legend.box.margin = margin(0, 0, 0, 5), 
       legend.text = element_text(size = 9), 
       legend.title = element_text(size = 9))

leg <- cowplot::get_plot_component(
  prec_leg,
  'guide-box-right',
  return_all = T
  )


grid1 <- cowplot::plot_grid(tmean, tmax, NULL, tmin, prec, NULL, 
                            nrow = 2, ncol = 3, rel_widths = c(1, 1, 0.05, 1, 1, 0.05))
grid2 <- cowplot::plot_grid(grid1, NULL, leg, ncol = 3, nrow = 1, rel_widths = c(1, 0.05, 0.3))
grid2
```

<p class = 'fxn'>Generate grid of all parameters in ACAD for 2024, Jan through May.</p>
Because waterNETN plotting functions return ggplot objects, we can tweak the plots so that temp plots all have the same y axis (so you can see that max is higher than min). 
```{r cache = T, message = F, warning = F}
data("NETN_clim_annual") # compiled annual data
data("NETN_clim_norms") # compiled normals
head(NETN_clim_annual)
ymin <- round(min(NETN_clim_annual$tmin, NETN_clim_norms$tmin_norm_1901_2000,     
                  NETN_clim_norms$tmin_norm_1991_2020), 0) - 1
ymax <- round(max(NETN_clim_annual$tmax, NETN_clim_norms$tmax_norm_1901_2000, 
                  NETN_clim_norms$tmax_norm_1991_2020), 0) -1

tmax <- climateNETN::plotClimComps(park = "ACAD", years = 2024, parameter = "tmax", data_type = "wstn",
                      layers = 'lines', legend_position = 'none', palette = c("red", "blue"),
                      plot_title = F) +
        ylim(ymin, ymax)
tmin <- climateNETN::plotClimComps(park = "ACAD", years = 2024, parameter = "tmin", data_type = "wstn", 
                      layers = 'lines', legend_position = 'none', palette = c("red", "blue"),
                      plot_title = F) +
        ylim(ymin, ymax)
tmean <- climateNETN::plotClimComps(park = "ACAD", years = 2024, parameter = "tmean", data_type = "wstn",
                       layers = 'lines', legend_position = 'none', palette = c("red", "blue"),
                      plot_title = F)+
        ylim(ymin, ymax) 
prec <- climateNETN::plotClimComps(park = "ACAD", years = 2024, parameter = 'ppt', data_type = "wstn",
                      layers = 'lines', legend_position = 'none', palette = c("red", "blue"),
                      plot_title = F)

prec_leg <- climateNETN::plotClimComps(park = "ACAD", years = 2024, parameter = 'tmax', data_type = "wstn",
                          layers = 'lines', legend_position = 'right', 
                          palette = c("red", "blue")) +
 theme(legend.box.margin = margin(0, 0, 0, 5), 
       legend.text = element_text(size = 9), 
       legend.title = element_text(size = 9))

leg <- cowplot::get_plot_component(
  prec_leg,
  'guide-box-right',
  return_all = T
  )


grid1 <- cowplot::plot_grid(tmean, tmax, NULL, tmin, prec, NULL, 
                            nrow = 2, ncol = 3, rel_widths = c(1, 1, 0.05, 1, 1, 0.05))
grid2 <- cowplot::plot_grid(grid1, NULL, leg, ncol = 3, nrow = 1, rel_widths = c(1, 0.05, 0.3))
grid2
```
</details>

#### plotClimCumPrecip()
<b style="color:red;">Note that this function now lives in climateNETN package</b>. This function plots cumulative monthly precipitation for a given year compared to either the 19th century or 30-year normal. If multiple parks or years are specified, resulting plots will be faceted on those variables.You can add gridlines to the x, y or both axes.

<p class='fxn'>Plot ACAD cumulative precipitation for 2020 through 2023 with gridlines on y axis and precip in inches.
```{r message = F, warning = F}
climateNETN::plotClimCumPrecip(park = "ACAD", years = 2020:2023, legend_position = 'bottom',
                  gridlines = "grid_y", units = 'eng')

```

<p class='fxn'>Plot ACAD cumulative precipitation for 2013 through 2023 for April - October only
```{r message = F, warning = F}
climateNETN::plotClimCumPrecip(park = "ACAD", years = 2014:2024, legend_position = 'bottom')

```

<p class='fxn'>Plot all but SAIR cumulative precipitation for 2023 with 4 columns
```{r message = F, warning = F}
parks <- c("ACAD", "MABI", "MIMA", "MORR", "ROVA", "SAGA", "SARA", "WEFA")
climateNETN::plotClimCumPrecip(park = parks, years = 2023, legend_position = 'bottom', numcol = 4)

```

<p class='fxn'>Plot cumulative precipitation for 2019 - 2023
```{r message = F, warning = F}
climateNETN::plotClimCumPrecip(park = "ACAD", years = 2019:2023, legend_position = 'bottom', numcol = 5)

```

#### plotClimRel()
<b style="color:red;">Note that this function now lives in climateNETN package</b>. This function plots a given year compared against either the 19th century normal (1901 - 2000) or the 1991 - 2020 normal. Both normals and annual comparisons are derived from NOAA gridded climate data. You can either plot all temp variables, min/max temp, mean temp or precipitation. If multiple years are specified, resulting plots will facet on year. You can make your own palette by specifying colors, or by default use viridis. Currently can only plot one park at a time. Can also add gridlines to x, y or both axes. 

<p class = 'fxn'>Plot all temperature variables on 1 graph for MABI in 2024 with gridlines on y axis and english units.</p>
```{r message = F, warning = FALSE}
climateNETN::plotClimRel(park = "MABI", years = 2024, parameter = "temp", units = "eng",
            palette = c("#EEE55A", "#D56062", "#067BC2"), gridlines = 'grid_y')
```

<p class = 'fxn'>Plot precip for SARA 2023 compared to 1990 - 2019 normals.</p>
```{r message = F, warning = FALSE}
climateNETN::plotClimRel(park = "SARA", years = 2023, parameter = "ppt", palette = "grey", normal = "norm1990")
```

<p class = 'fxn'>Plot precip for SARA 2023 and 2024 compared to 1990 - 2019 normals.</p> 
```{r message = F, warning = FALSE}
climateNETN::plotClimRel(park = "SARA", years = 2023:2024, parameter = "ppt", 
            palette = "grey", normal = "norm1990")
```

<p class = 'fxn'>Plot precip for LNETN parks in 2023 without a legend and with 4 columns instead of 3. </p> 
```{r message = F, warning = FALSE}
climateNETN::plotClimRel(park = "LNETN", years = 2023, parameter = "ppt", palette = "grey", legend_position = 'none', numcol = 4)
```

<p class = 'fxn'>Same as above, but with full park names as facet titles. </p> 
```{r message = F, warning = FALSE}
climateNETN::plotClimRel(park = "LNETN", years = 2023, parameter = "ppt", palette = "grey", legend_position = 'none', numcol = 4, title_type = "UnitName")
```

#### plotClimDrought()
<b style="color:red;">Note that this function now lives in climateNETN package</b>. This function plots weekly drought index at the county level for each specified park or weather station nearest to a specified park. Resulting plot shows the percent of county area in 5 levels of drought, with D0 = Abnormally Dry, D1 = Moderate Drought, D2 = Severe Drought, D3 = Extreme Drought, and D4 = Exceptional Drought. Drought designations come from the U.S. Drought Monitor. If multiple parks are specified, results will be faceted with a separate plot for each park. Where multiple counties occur in a park, data can be faceted by county if `dom_county = FALSE`. To only plot predominant county, specify `dom_county = TRUE` (default).

I tweaked the x-axis formatting a bit based on whether 1 year or many years are plotted. Let me know if you'd like further tweaks. You can also now add gridlines.

<p class='fxn'>Plot drought info for ACAD in 2023 wiht gridlines on y axis</p>
```{r}
climateNETN::plotClimDrought(park = c("ACAD"), years = 2023, gridlines = "grid_y", legend_position = 'bottom')
```

<p class='fxn'>Plot drought info for MABI and SAGA for 2020 to 2024 with gridlines on x axis.</p>
```{r}
climateNETN::plotClimDrought(park = c("MABI", "SAGA"), years = 2020:2024, gridlines = "grid_x", legend_position = 'bottom')
```

<p class='fxn'>Plot drought info for both MORR counties for 2023</p>
```{r}
climateNETN::plotClimDrought(park = "MORR", years = 2023, dom_county = FALSE, legend_position = "bottom")
```

<p class="fxn">Plot drought info for both ACAD counties in 2020 for May through October </p>
```{r message = F, warning = F}
climateNETN::plotClimDrought(park = "ACAD", years = 2020, dom_county = FALSE, months = 5:10, legend_position = "bottom")
```

<p class="fxn">Plot drought info for MABI, SAGA, and SARA in 2023 with legend on bottom </p>
```{r message = F, warning = F}
climateNETN::plotClimDrought(park = c("MABI", "SAGA", "SARA"), years = 2023, legend_position = 'bottom')
```


### Summary Functions {.tabset}
#### sumEvents()
Summarize number of samples collected per park, site, month, and parameter. Resulting data frame show number of samples collected for each month, and whether the value is real (month) or censored (month_cens).

<p class = 'fxn'>Summarize all events for ACAD for all years and active sites</p>
```{r}
acad_ev <- sumEvents(park = "ACAD")
print_head(acad_ev)

```

<p class = 'fxn'>Summarize only lake events for ACAD for all years</p>
```{r}
acad_lk <- sumEvents(park = "ACAD", site_type = "lake")
print_head(acad_lk)
```

<p class = 'fxn'>Summarize LNETN events only</p>
```{r}
lnetn <- sumEvents(park = "LNETN")
print_head(lnetn)
```

